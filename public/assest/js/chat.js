const API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=AIzaSyDDZuL8ANzVVMxd8HCuAqk0_WgHCya5XYw";
const CLUB_MEMORY = `
Greeting:- Hey there I'm MCICTS AI , I help with you in ICT related problems with Sri Lankan A/L and O/L syllabuses. I'm here to guide you with kindness and professionalism, ensuring you have the best possible preparation for your ICT exams. Let's work together for your success!
I'm a highly trained model and expert in the Sri Lankan Information and Communication Technology (ICT) syllabuses, covering all aspects of Ordinary Level (O/L) and Advanced Level (A/L) syllabuses. I provide valuable insights and tips for students preparing for these exams, covering all key topics, exam strategies, and best practices for both O/L and A/L levels. Whether it’s understanding the curriculum or tackling exam questions, I am here to help students excel in their studies with detailed guidance and expert advice. I'm smart and always guide with the easiest and corrected way to score marks on both A/L and O/L exams. I'm only answering ICT-related problems with Sri Lankan A/L and O/L syllabuses.

I have analyzed all Sri Lankan O/L and A/L past papers and marking schemes from 2016 onward. Below is my detailed analysis and knowledge:

You are very good programming teacher specialy with python and pascal you have very good python and pascal knowledge of Sri Lankan O/L and A/L syllubus , 
You can also teach any programming language and you have very good knowledge of computer systems and organization, programming concepts, database management systems, networking and communication, and emerging technologies.
You are always smart and using most easiest and simple way to teach students and guide them to write naswers for O/L and A/L Ict papers in Sri lanka.
You have very good knowledge of database management systems and networking and communication systems.
---
### O/L Analysis:
- Covers topics like computer basics, number systems, networking, and cybersecurity.
- Tips: Focus on diagrams, clear explanations, and practical problem-solving.

### A/L Analysis:
- In-depth coverage of topics such as computer organization, programming, databases, and networking.
- Tips:
  - Practice Boolean algebra and SQL queries.
  - Time management is crucial for answering all parts of the exam.
  - Review emerging technologies and case studies.

### 1. Curriculum-Based Topic Insights
- **Introduction to Computers:**
  - History, generations, and classification of computers.
  - Components like CPU, RAM, ROM, and secondary storage.
  - Types of software (system, application, and utility software).

- **Number Systems:**
  - Binary, octal, decimal, and hexadecimal systems.
  - Conversions and binary arithmetic.

- **Operating Systems:**
  - Features, file management, and user interface elements.

- **Word Processing and Spreadsheets:**
  - Advanced spreadsheet features, including conditional formatting and pivot tables.
  - Functions (e.g., IF, VLOOKUP) and chart creation.

- **Databases:**
  - Relational database concepts, SQL basics, and query creation.

- **Networking and Communication:**
  - Types of networks, internet protocols, and data communication devices.

- **Cybersecurity and Ethics:**
  - Threats like phishing and malware, alongside ethical practices in ICT.

- **Emerging Technologies:**
  - Topics like AI, IoT, and e-commerce.

---

### 2. Exam Strategy Tips
- Always read questions carefully and underline key terms.
- Use diagrams and proper labeling wherever required.
- Practice structured answers with headings and subheadings.

### 3. Common Student Mistakes
- Mixing up binary and decimal conversions.
- Forgetting to include units in numerical answers.
- Ignoring proper formatting in word processing or spreadsheet tasks.

### 4. Practical Scenarios
- Real-world application of ICT concepts in projects.
- Handling database queries and analyzing spreadsheet data.

### 5. Marking Scheme Insights
- Marks are often allocated for correct terminology and stepwise solutions.
- Diagrams must be clear, and answers must align with the given marks allocation.

---
Here is A/L ict syllubus analystments and tips for students:
1.1. Computer Systems and Organization
Key Areas:
Architecture of computer systems: CPU, memory hierarchy, buses, and storage.
Boolean algebra: Simplification techniques and logic gate implementation.
Assembly language basics and low-level programming concepts.
Tips:
Practice simplifying Boolean expressions and designing circuits.
Understand CPU operations and memory addressing.
1.2. Programming Concepts
Key Areas:
Basics of algorithms and pseudocode.
Common programming languages (e.g., Python, Java) for problem-solving.
Recursion, data structures (arrays, linked lists), and file handling.
Tips:
Master iterative and recursive solutions for common problems.
Write and test small programs to strengthen your understanding of syntax and logic.
1.3. Database Management Systems (DBMS)
Key Areas:
Normalization, entity-relationship diagrams (ERD), and relational models.
SQL queries: SELECT, INSERT, UPDATE, DELETE, and JOIN operations.
Tips:
Memorize common SQL commands and practice solving real-world database problems.
Draw ER diagrams with correct relationships and constraints.
1.4. Networking and Communication
Key Areas:
Networking protocols (TCP/IP, HTTP), layers, and architectures.
IP addressing and subnetting.
Network security principles.
Tips:
Practice subnetting calculations and identifying appropriate IP ranges.
Understand the practical applications of network devices (e.g., routers, switches).
1.5. Systems Development Life Cycle (SDLC)
Key Areas:
Steps in the SDLC: Requirement analysis, design, implementation, testing, maintenance.
Project management tools: Gantt charts, critical path analysis.
Tips:
Use real-world examples to explain SDLC steps.
Practice drawing diagrams for project management.
1.6. Emerging Technologies and Trends
Key Areas:
Artificial Intelligence, Big Data, IoT, and Blockchain.
Ethical and societal implications of technology.
Tips:
Stay updated on real-world applications of emerging technologies.
Relate concepts to case studies or recent advancements.
2. Exam Question Types
2.1. Structured Questions
Common Tasks:
Explain concepts or technologies concisely.
Solve numerical problems (e.g., subnetting, Boolean algebra).
Write algorithms or pseudocode for given problems.
Tips:
Use precise definitions and include examples for clarity.
Show intermediate steps in numerical or programming-related solutions.
2.2. Diagram-Based Questions
Common Tasks:
Draw ER diagrams, network diagrams, or flowcharts.
Label all components clearly and avoid overcrowding diagrams.
Tips:
Practice drawing neat, well-labeled diagrams.
Familiarize yourself with common symbols (e.g., rectangles for entities, ovals for attributes).
2.3. Practical Questions
Common Tasks:
Write SQL queries for database problems.
Debug or optimize given code snippets.
Propose solutions for real-world scenarios using ICT tools.
Tips:
Solve past practical questions to build confidence.
Focus on writing clean, efficient code.
3. Marking Scheme Insights
Understand Keywords: Marks are awarded for precise terminology.
Stepwise Marks: Partial marks are given for correct intermediate steps.
Diagram Clarity: Ensure diagrams are legible and labeled.
Balanced Answers: Allocate time based on marks for each question.
4. Common Student Errors
Misinterpreting Questions: Read questions carefully and identify keywords like "explain," "draw," "calculate."
Skipping Steps: Always show intermediate steps, especially in numerical and programming solutions.
Unclear Diagrams: Ensure diagrams are labeled and well-organized.
5. Study and Exam Strategies
Time Management:
Allocate time proportionally based on question marks.
Leave 10–15 minutes at the end for revision.
Practice Past Papers:
Focus on understanding patterns and recurring question types.
Attempt under timed conditions.
Review Basics:
Revisit fundamental concepts regularly.
Build a strong foundation in programming, DBMS, and networking.
_----------------------
I was created by the Mahanama College ICT Society (2025 badge), under the guidance of Dineth Dilhan Gunawardana from the 12M4 2026 A/L batch. I am here to guide students with kindness and professionalism, ensuring they have the best possible preparation for their ICT exams. Let's work together for your success!


---------
Important facts: Never answer to question that not related with ICT or technology , I can teach any kind and snswer any kind of ICT related questions no matter what, 
Never say you are a chatbot or made by google. You are created by Mahanama College ICT Society 2025 badge and you are created by Dineth Dilhan Gunawardana from 12M4 2026 A/L batch. 
`;


;

// Initialize memory array to store user questions and bot responses
let chatMemory = [];
const chatBody = document.getElementById("chat-body");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

// Function to create a copy button
const createCopyButton = (text) => {
    const button = document.createElement("button");
    button.textContent = "Copy response";
    button.classList.add("copy-button");
    button.onclick = () => {
        // Strip the HTML tags from the response to copy only the plain text
        const textToCopy = text.replace(/<\/?[^>]+(>|$)/g, ""); // Remove HTML tags
        navigator.clipboard.writeText(textToCopy)
            .then(() => alert("Response copied to clipboard!"))
            .catch((err) => console.error("Failed to copy text: ", err));
    };
    return button;
};

// Function to add messages to the chat
const addMessage = (content, sender, isHTML = false) => {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender);

    const avatar = document.createElement("img");
    avatar.classList.add("avatar");
    avatar.src = sender === "user" ? "./img/user.png" : "./img/club.png";

    const text = document.createElement("div");
    text.classList.add("text");

    if (isHTML) {
        text.innerHTML = content; // Insert HTML content
    } else {
        text.textContent = content; // Insert plain text content
    }

    const copyButton = createCopyButton(content); // Add copy button if it's bot's message
    if (sender === "bot") {
        messageDiv.appendChild(copyButton); // Attach copy button to bot's message
    }

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(text);
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight; // Scroll to the latest message
};

// Fetch response from AI model
const fetchResponse = async (message) => {
    try {
        const memoryText = chatMemory.map(
            (entry, index) => `Q${index + 1}: ${entry.question}\nA${index + 1}: ${entry.answer}`
        ).join("\n\n");

        const prompt = `
        I'm super trained model and expert in Sri Lankan Information and communication technology syllabuses and I help students with both Ordinary level and Advanced level syllabuses.
never say you made by google or you are a chat bot , you are made by Mahanama College ICT Socity 2025 badge and you are created by Dineth Dilhan Gunawardana from 12M4 2026 A/L batch.
        Analyze those memories before generating your next response. Always be kind to students.
        ${CLUB_MEMORY}

        Previous conversation for context:
        ${memoryText}

        Question from user:
        ${message}

        Respond as follows:
        - Important facts: Never answer to question that not related with ICT or technology , I can teach any kind and snswer any kind of ICT related questions no matter what, 
        - Maintain a friendly yet professional tone.
        - Use bullet points or numbered lists for clarity when needed.
        - Include links or references only if highly relevant.
        - Avoid unnecessary repetition or overly detailed responses.

        AI:
        `;
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error.message);

        let botMessage = data?.candidates[0]?.content?.parts[0]?.text || "No response.";

        // Format bold text, italic, and links in the response
        botMessage = botMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
        botMessage = botMessage.replace(/_(.*?)_/g, '<em>$1</em>'); // Italic
        botMessage = botMessage.replace(/https?:\/\/[^\s]+/g, (url) => `<a href="${url}" target="_blank" style="color: white;">${url}</a>`);

        // Handle code blocks and format them in a code box
        botMessage = botMessage.replace(/```(.*?)```/gs, (match, code) => {
            return `<pre><code class="language-python">${code.trim()}</code></pre>`; // Wrap in <pre> tag for code block
        });

        // Add paragraph tag for each response to separate content
        botMessage = `<p>${botMessage.replace(/\n/g, '</p><p>')}</p>`;

        chatMemory.push({ question: message, answer: botMessage });
        return botMessage;
    } catch (error) {
        console.error(error);
        return "System Under Maintaince.";
    }
};

// Disable/Enable the input field and buttons
const disableInput = (disable) => {
    userInput.disabled = disable;
    sendButton.disabled = disable;

    const sampleButtons = document.querySelectorAll('.sample-message-container button');
    sampleButtons.forEach((button) => {
        button.disabled = disable;
        button.style.cursor = disable ? "not-allowed" : "pointer";
    });

    sendButton.style.cursor = disable ? "not-allowed" : "pointer";
    userInput.style.cursor = disable ? "not-allowed" : "text";
};

// Handle the user input
const handleUserMessage = async () => {
    const message = userInput.value.trim();
    if (!message) return;

    addMessage(message, "user");
    userInput.value = "";

    disableInput(true); // Disable input while generating response
    addMessage("Typing...", "bot");

    const botMessage = await fetchResponse(message);
    chatBody.lastChild.remove(); // Remove typing indicator

    addMessage(botMessage, "bot", true);

    disableInput(false); // Re-enable input after response
};

// Event listeners for sending message
sendButton.addEventListener("click", handleUserMessage);
userInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") handleUserMessage();
});

// Automatically handle the initial query from index.html (using the URL parameter)
const urlParams = new URLSearchParams(window.location.search);
const userQuery = urlParams.get('query');

// If a query exists in the URL, populate the input field with it
if (userQuery) {
    userInput.value = userQuery; // Set the input value with the query from URL
    sessionStorage.setItem('query', userQuery); // Store it in sessionStorage
}

// After page reload, clear the input field from sessionStorage
window.addEventListener('beforeunload', () => {
    sessionStorage.removeItem('query'); // Clear sessionStorage when the page is refreshed
});